FROM node:22-alpine

WORKDIR /app

# Copy workspace files
COPY package.json package-lock.json ./
COPY tsconfig.json ./
COPY packages/mcp-server ./packages/mcp-server
COPY packages/aggregator ./packages/aggregator
COPY packages/integrations ./packages/integrations  
COPY packages/shared ./packages/shared

# Install dependencies
RUN npm install

# Bundle the MCP server
RUN npm run bundle --workspace=@agent47/mcp-server

# Production stage
FROM node:22-alpine
WORKDIR /app

# Only copy the bundled file - it has EVERYTHING
COPY --from=0 /app/packages/mcp-server/dist/server.cjs ./

ENV NODE_ENV=production
ENV PORT=3002

EXPOSE 3002

CMD ["node", "server.cjs"]
